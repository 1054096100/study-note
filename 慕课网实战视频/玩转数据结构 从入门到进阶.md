# 玩转数据结构 从入门到进阶

## 第12章 AVL

（AVL树也是二分搜索树，只不过是自平衡的）

### 12-1 平衡树和AVL

#### 定义

对于任意一个节点，左子树和右子树的高度差不能为超过1

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/1.png)

当我们往这个平衡二叉树添加一个节点（节点的值是2）的时候，这棵二叉树变为下图：

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/2.png)

此时，这棵树已经不是平衡二叉树了。

我们给每个节点标注一下它的高度，如下图所示：

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/3.png)

#### 平衡因子

每个节点的平衡因子指的是该节点的**左子树高度 - 右子树高度**，如下图所示；

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/4.png)

我们通过平衡因子就可以判断一棵树是否是平衡二叉树。（只要二叉树中某个节点它的平衡因子大于等于2或者小于等于-2（即绝对值大于等于2），那么这棵树就不是平衡二叉树）。从图中我们可以看出，值为8、值为12的这两个节点它们的平衡因子是2，所以这两个节点破坏了平衡二叉树的性质。

一旦我们计算出了每个节点的平衡因子，那么我们就可以判断当前的二叉树是否是一棵平衡二叉树。

### 12-2 计算节点的高度和平衡因子

每个节点默认高度初始化为1，也就是说对于每一个新的节点，默认它为叶子节点（即添加的位置一定是一个叶子节点的位置），因此高度为1。

### 12-4 旋转操作的基本原理

#### AVL树的左旋转和右旋转

##### 在什么时候维护平衡

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/5.png)

当我们插入值为28的这个节点之后，它的祖先节点的高度可能会发生改变，因此就可能会影响到祖先节点的平衡因子，所以我们需要沿着插入节点向上回溯，计算祖先节点的平衡因子。

###### 右旋转

举一个简单的例子，从一棵空树开始添加节点，如下图：

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/6.gif)

此时，这个二叉树是不平衡的。

第二个例子：

如果平衡二叉树已经存在，现在继续插入一个节点：

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/7.gif)

我们从下面开始找，直到找到第一个不平衡节点 -- 在这里是值为8的节点。

第一个例子和第二个例子的本质都是一样的：都是**插入的元素在不平衡节点的左侧的左侧**。

此时，为了保持这棵树是平衡的，我们需要对这棵树进行右旋转的操作，我们把这个问题抽象为下图所示：

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/8.png)

其中，值为y的节点它的平衡因子是大于1的，其他节点的平衡因子是小于等于1的。而子树T1、T2、T3、T4它们可能为空，也可能不为空。

对这棵树进行右旋之后，除了要使得这棵树变为平衡之外，还要保持这棵树是二分搜索树。

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/9.png)

右旋转的过程如下：

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/10.gif)

可以看到，这棵树依然是二分搜索树。

证明这棵树是平衡的：

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/11.gif)

这个过程对于y节点来说，相当于顺时针的转到了x右子树位置。这个顺时针的方向从x的角度来看，就是向右进行了一个旋转。

对于左边的图：

因为值为z的那个节点是平衡的，所以T1和T2它们的高度差最大是1。我们假设T1和T2中最大的高度是h，因此，值为z的节点的高度是h + 1。又因为值为x的节点是平衡的，所以z树和T3的高度差最大是1，因此T3的高度要么是h + 1，要么是h，所以值为x的节点的高度是h + 2。

值为y的这个节点是不平衡的，并且它的平衡因子是2（因为我们只是添加了一个节点使得y不平衡了，所以y的平衡因子不可能一下增加了2，因此，y节点此时的平衡因子是2（即从1变成了2））。所以，T4的高度是h。

对于右边的图：

从左边的图可以看，右旋转之后，y节点是平衡的了。并且x也是平衡的。

###### 左旋转

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/12.png)

其中，y的左子树的高度减去右子树的高度小于 -1。在这种情况下，我们就需要进行左旋转。

![](http://oklbfi1yj.bkt.clouddn.com/%E7%8E%A9%E8%BD%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6/13.gif)

















