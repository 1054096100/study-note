# DNS

**DNS同时占用UDP和TCP端口53是公认的**，这种单个应用协议同时使用两种传输协议的情况在TCP/IP栈也算是个另类。

如果用wireshark、sniffer或古老些的tcpdump抓包分析，会发现几乎所有的情况都是在使用UDP，使用TCP的情况非常罕见，神秘兮兮。

**DNS主要还是使用UDP，解析器还是服务端都必须自己处理重传和超时**。DNS往往需要跨越广域网或互联网，分组丢失率和往返时间的不确定性要更大些，这对于DNS客户端来说是个考验，好的重传和超时检测就显得更重要了。

## 为什么既使用TCP又使用UDP

首先了解一下TCP与UDP传送字节的长度限制： UDP报文的最大长度为512字节，而TCP则允许报文长度超过512字节。

**当DNS查询超过512字节时，协议的TC标志出现删除标志，这时则使用TCP发送**。通常传统的UDP报文一般不会大于512字节。 

### 区域传送时使用TCP

主要有以下两点考虑： 
1、辅域名服务器会定时（一般时3小时）向主域名服务器进行查询以便了解数据是否有变动。如有变动，则会执行一次区域传送，进行数据同步。**区域传送将使用TCP而不是UDP，因为数据同步传送的数据量比一个请求和应答的数据量要多得多**。 
2、TCP是一种可靠的连接，保证了数据的准确性。 

### 域名解析时使用UDP协议

客户端向DNS服务器查询域名，一般返回的内容都不超过512字节，用UDP传输即可。不用经过TCP三次握手，这样DNS服务器负载更低，响应更快。虽然从理论上说，客户端也可以指定向DNS服务器查询的时候使用TCP，但事实上，很多DNS服务器进行配置的时候，仅支持UDP查询包。







