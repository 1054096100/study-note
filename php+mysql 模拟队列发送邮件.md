# php+mysql 模拟队列发送邮件

### 1、为什么需要队列

我们需要给网站所有用户发送一封系统通知邮件，假设网站有10000个注册用户，发送每一封邮件需要0.1秒，执行一那么把这些邮件发送完需要1000秒。也就是说，在这1000秒内，浏览器是不能动的，动了的话就会终止邮件的发送。而且，如果在发送邮件的过程中，网络出现了问题，那么这一万封也是发不完的

而使用队列的话，就不需要等待了，可以做其他事情

### 2、引入CLI

首先，我先写一个队列（命名为`cli_test.php`）：

```php
<?php
    
    $count = 0;
    while (true) {
        ++$count;
        echo $count."\n";
        if ($count >= 10) {
            break;
        }
        sleep(3);
    }
    echo "done";
```



### 3、使用shell_exec()来触发队列

Linux下：通过使用`exec_shell()`这个函数来执行`cli`

Windows下：通过使用`exec()`这个函数来执行`cli`

例如：

```php
<?php
    
    shell_exec('php cli_test.php');
```

注意，此时的这个脚本应该和`cli_test.php`这个脚本位于同一级目录里

### 4、在phpcli模式下测试邮件队列

#### 1、建表存储需要发送的邮件

#### 2、使用 php + mysql 轮询 实现队列

##### 轮询的意思

**每隔一段时间**就去查询数据库（可以使用`sleep`函数来控制时间间隔）

那么查询什么东西呢？

例如，我要发送同一封邮件给所有的用户。那么，就需要查询数据库中有哪些用户（包括新注册的用户）。那么，怎么查询新注册的用户呢？这里就可以使用轮询了（即，每隔一段时间就查询一次数据库）

使用轮询的方式每次查出 n 条（条数自己控制）

##### 队列指的是什么呢？

例如，我有一张用户表（`users`），里面放了已经注册的所有用户。我还有一张邮件队列表（`task_list`），里面放了需要发送邮件的用户（每次往队列表添加用户的时候，都是添加到最后一条记录，也就是队尾）

![](http://oklbfi1yj.bkt.clouddn.com/php+mysql%20%E6%A8%A1%E6%8B%9F%E9%98%9F%E5%88%97%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/1.PNG)

点击注册的时候，就触发了`queue.php`这个脚本（这个脚本用来给处于队列中的用户发送邮件）

#### 3、在cli模式下测试队列





























































