# malloc内存分配与free内存释放的原理

## 1、为什么要使用malloc

主要是因为在代码中，**为了节约内存，很多数据都是动态生成的**，所以会用malloc

## 2、碎片的问题

**会有内部碎片与外部碎片的问题，内部碎片难以消除（因为字对齐之类的问题），而外部碎片是可以消除的**（如果不消除的话，外部的内存块越来越小，虽然数量多了，但是利用率会急剧下降！）

## 3、隐式的空闲链表

用链表的方法把堆空间给联系起来了。特点明显，实现简单，但**分配时查询空堆块是线性时间**的。

## 4、放置以分配的块

1）、**首次**适配（即第一次调用malloc）：从链表头开始寻找适合的空堆块，直到找到为止；

2）、下一次适配：从上一次的分配点开始找，直到找到适合的空堆块为止；

3）、最佳适配：**查询整个链表，找到最合适**（浪费最小）的空堆块。（这样会更加浪费时间）

## 5、分割空闲块

当前的分配的空堆块比所需要的空间大很多的时候，如果不分割，就会照成内部碎片过大，利用率下降。（即这次分配出的内存如果有多，那么是不可以分配给下一次用的。除非内部碎片被合并了，那么就可以被下一次分配使用）

当需要3个字节的空间时，首次适配找到了满足条件的第二个堆块，但堆块过大，所以分割成两个16字节的堆块。

如果，在如上的情况下，合并两个块，由于当前块不知道上一个块的情况,它要通过遍历整个链表才能知道上一个堆块的空间是否为空，这样将花费线性的时间来合并与当前相邻的空闲堆块。有个类似双向链表的方法（不过不是真正的双向链表，只是可以加一个信息量，直接就可以知道上一个堆块的情况）



























