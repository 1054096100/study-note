# 中断管理

![](http://oklbfi1yj.bkt.clouddn.com/FreeRTOS/5.jpg)

嵌入式实时操作系统需要对整个系统环境所产生的事件做出反应。例如串口收到数据，引脚电平变化，各种总线收到数据等事件。**对这些事件的处理以及时间要求各有不同，需要在不同情况下做出合理判断，以达到最佳事件处理的策略**。

本节主要讲：

- 哪些FreeRTOS的API函数可以在中断服务例程中使用。
- 延迟中断方案是如何实现的。
- 如何创建和使用二值信号量以及计数信号量。
- 二值信号量和计数信号量之间的区别。
- 如何利用队列在中断服务例程中把数据传入传出。
- 一些FreeRTOS移植中采用的**中断嵌套**模型。


## 1、中断的延迟处理

### 采用二值信号量同步

**二值信号量可以在中断发生时，让任务解除阻塞**，**相当于让任务与中断同步**（如何理解？当中断到来时，当前进程会被阻塞。那么为什么说二值信号量可以在中断发生时，让任务解除阻塞？信号量和中断有什么关系？）。此时**可以让中断事件中的大部分的工作在任务中完成，中断本身只适合处理少量的工作**。

存取二值信号量使用 take 和 give 两个动作。分别使用xSemaphoreTake()和函数xSemaphoreGiveFromISR()两个函数。**二值信号量可以看作一个深度为1的队列。这个队列不空则为满，拥只有两个状态**。

（FreeRTOS的二值信号量的底层是通过队列来实现的吗？）

### 创建二值信号量

###### vSemaphoreCreateBinary()函数

参数：
​    xSemaphore 创建的信号量
返回值：
​    无

```C
vSemaphoreTake()函数
参数：
    xSemaphore 获得的信号量
    xTickToWait 阻塞超时时间
返回：
    pdPASS 成功获取信号量
    pdFALSE 未能获取信号量
```

```c
vSemaphoreGiveFromISR()函数
参数：
    xSemaphore 给出的信号量
    pxHigerPriorityTaskWoken 是否解除阻塞的任务优先级高于当前任务
返回：
    pdPASS 调用成功
    pdFAIL 信号量已经有效，无法给出
```

## 2、计数信号量

在中断频率比较低的情况下，二值信号量足以满足。**当中断频率很高，当一个任务还没处理上一个的中断就又有新的中断发生，此时若仍然使用二值信号量则会丢失后一次中断的事件，此时我们可以使用计数信号量来处理**。

### 计数信号量有以下两种典型用法

#### 事件计数

在这个用法中，每次事件发生，中断服务程序都会give信号量，**信号量在每次被give的时候计数会加1**。**延迟处理任务每处理一次或Take一次信号量，此时信号量会减1**，此时信号量可以看作事件发生的次数与被处理次数的差值。

#### 资源管理

**在这种用法中，信号量计数用于表示可用资源的数目。一个任务要获取资源控制权，其必须先获得信号量。当计数值减到0，则表示没有可用资源**。当任务利用资源完成工作后，将give信号量。

（也就是说，计数信号量的值与资源的数目相对应）

如果信号量的值是1（也就是二值信号量），那么可以起到一个进程同步的作用。（当然，也是可以起到资源管理的作用啦）

### 创建计数信号量

```c
xSemaphoreCreateCounting()函数
参数：
    uxMaxCount 最大计数值
    uxInitiaCount 信号量的初始计数值
返回：
    信号量句柄
    NULL 表示创建失败
```

## 3、在中断服务中使用队列

```c
xQueueSendToFrontFromISR()函数
xQueueSendToBackFromISR()函数
参数：
xQueue 目标队列句柄
pvltemToQueue 发送数据的指针
xTicksToWait 阻塞超时时间
返回：
pdPASS数据被成功发送。
errQUEUE_FULL队列已满。
```

```c
xQueueReceiveFromISR()函数
参数：
    xQueue 读取队列的句柄
    pvBuffer 接收缓存指针
    xTicksToWait 阻塞超时时间
返回：
    pdPASS数据被成功接收。
    errQUEUE_FULL队列为空。
```

## 4、中断嵌套

使用STM32（这是一个基于专为要求高性能、低成本、低功耗的**嵌入式应用**专门设计的ARM系列）时需要注意，**在STM32中大的数字表示低中断优先级，小的数字表示高优先级，其最高优先级为0**。

（其中，ARM可以翻译为进阶精简指令集机器）

两个与中断嵌套相关的常量
configKERNEL_INTERRUPT_PRIORITY  设置系统心跳时钟的中断优先级。
configMAX_SYSCALL_INTERRUPT_PRIORITY  设置可以使用 FREERTOS API 的最高优先级。