# Linux 线性地址，逻辑地址和虚拟地址的关系

**以下讲解都是在 Intel 32 位下，并且以代码段为例 (之所以不讲 64 位是因为在 64-bit long mode 下分段直接被禁用了，内存完全平坦，没什么可以讲的...)**

在 Intel 平台下，**逻辑地址(logical address)是 selector:offset 这种形式**，selector 是 CS 寄存器的值，**offset 是 EIP 寄存器的值**。如果用 selector 去 GDT( 全局描述符表 ) 里拿到 segment base address(段基址) 然后加上 offset(段内偏移)，这就得到了 **linear address**。我们把这个过程称作**段式内存管理**。

如果再把 linear address 切成四段，用前三段分别作为索引去PGD、PMD、Page Table里查表，最终就会得到一个页表项(Page Table Entry)，那里面的值就是一页物理内存的起始地址，把它加上 linear address 切分之后第四段的内容(又叫页内偏移)就得到了最终的 physical address。我们把这个过程称作**页式内存管理**。

问题来了，为什么没提到 virtual address，这是个什么东西？其实在 Intel IA-32 手册里并没有提到这个术语，但是在内核的确是用到了这个概念，比如__va和__pa这两个宏定义。看似神秘的 **virtual address 究其本质就是程序里面使用的地址比如一个指针值，指针的本质就是 EIP 寄存器里的值**，**说直白点，virtual address 就是 EIP 寄存器的值。**你会发现我们上面说过，logical address 由 selector 和 offset 两部分组成，offset 也是 EIP 寄存器的值，所以结论为：logical address 的 **offset 正是 virtual address**，**它俩是一个东西**。

既然搞明白了 logical address 和 virtual address 的关系，那么我们再来看下，linear address 和 virtual address 是什么关系。在上面讲到的段式内存管理中，**Linux 内核会将 segment base address(段基址)设成 0**，于是就有 linear address = 0+offset，又因为 virtual address 就是 offset，所以算出的 linear address在**数值上**等于 virtual address，注意，**是数值上等于，它们之间是差了段基址的，只不过段基址为 0 罢了**。

网上很多资料认为逻辑地址是虚拟地址的别名，其实它们不是一个东西。还有很多资料把线性地址当作虚拟地址的别名，其实它们也不是一个东西，只是Linux在x86下将它们搞得数值相等而已，**虽然值相等但是本质不同**。

---------------------------------我是分割线-------------------------------------------

讲到这里，三者之间的关系就讲明白了，最后说下为什么这三个概念会如此混乱。

按照 Intel 的设计，段式内存管理中的段类型分为三种：代码段(上面讲了)、数据段、系统段(TSS之类的)，实在是太麻烦了。我们只靠页式内存管理就已经可以完成Linux内核需要的所有功能，根本不需要段映射，但是段映射这玩意儿又关不掉，那就只能上点手段了。于是，Linux内核将所有类型的段的 segment base address 都设成0，段限长都设成**最大**(具体数值不展开讲了，涉及到段描述符结构，很麻烦，这里理解成地址总线的最大寻址限度即可)*，那么这样一来所有段都重合了，也就是不分段了，此外由于段限长是地址总线的寻址限度，所以这也相当于所有段跟整个线性空间重合了。虚拟地址本来是在段内的偏移量，现在段就是整个线性空间，所以虚拟地址就成了在整个线性空间内的偏移量，这和线性地址的概念一样，所以内核开发者都已经将虚拟地址和线性地址当作一个东西了。像是 Understand The Linux Kernel 这本书里面为了避免混淆，除了在开头和术语表中引用了  virtual address 这个词组之外，其他地方全是用的 linear address。

看完这个答案，你会发现我们绕了一圈回来，虽然逻辑地址的概念很清晰，但是虚拟地址和线性地址依然可以不作区分，因为区分了也没什么用，内核里这俩概念是通用的。不过，知道点区别还是不至于在某些时候把自己搞晕，尤其是有些书和教程里面这两个词不说缘由就混着用，这很蛋疼。好了，最后结论就是，这两个概念区分开来的确更加清晰，但如果不作区分而直接把虚拟地址看作线性地址的别名，对你理解内核也不会产生任何影响。