# 分页的思想

## 分页思想

分页的思想：**程序运行时用到哪页就为哪页分配内存，没用到的页暂时保留在硬盘上。当用到这些页时再在物理地址空间中为这些页分配内存，然后建立虚拟地址空间中的页和刚分配的物理内存页间的映射**。

**应用程序文件与进程地址空间做映射，进程地址空间与物理内存做映射**。

## 举个例子

下面通过介绍一个可执行文件的装载过程来说明分页机制的实现方法。**一个可执行文件** (PE 文件 ) 其实就是一些编译链接好的数据和指令的集合，它也**会被分成很多页**，在 PE 文件执行的过程中，它往内存中装载的单位就是页。当一个 PE 文件被执行时，操作系统会**先**为**该程序**创建一个 4GB 的进程虚拟地址空间。前面介绍过，**虚拟地址空间只是一个中间层**（可以把进程地址空间理解为页目和页表）而已，它的功能是**利用一种映射机制将虚拟地址空间映射到物理地址空间**，所以，**创建 4GB 虚拟地址空间其实并不是要真的创建空间，只是要创建那种映射机制所需要的数据结构而已**，**这种数据结构就是页目和页表**。
当创建完虚拟地址空间所需要的数据结构后，进程开始读取 PE 文件的第一页。**在PE 文件的第一页包含了 PE 文件头和段表等信息，进程根据文件头和段表等信息，将 PE 文件中所有的段一一映射到虚拟地址空间中相应的页** (PE 文件中的段的长度都是页长的整数倍 ) 。**这时 PE 文件的真正指令和数据还没有被装入内存中，操作系统只是根据 PE 文件的头部等信息建立了 PE 文件和进程虚拟地址空间中页的映射关系而已**。当 CPU 要访问程序中用到的某个虚拟地址时，并且CPU 发现该地址并没有相关联的物理地址时， CPU 认为该虚拟地址所在的页面是个空页面， CPU 会认为这是个**页错误** (Page Fault) ， CPU 也就知道了操作系统还未给该 PE 页面分配内存，CPU 会将控制权交还给操作系统。**操作系统于是为该 PE 页面在物理空间中分配一个页面，然后再将这个物理页面与虚拟空间中的虚拟页面映射起来**，然后将控制权再还给进程，进程从刚才发生页错误的位置重新开始执行。由于此时已为 PE 文件的那个页面分配了内存，所以就不会发生页错误了。随着程序的执行，页错误会不断地产生，操作系统也会为进程分配相应的物理页面来满足进程执行的需求。
分页方法的核心思想就是当可执行文件执行到第 x 页时，就为第 x 页分配一个内存页 y ，然后再将这个内存页添加到进程虚拟地址空间的映射表中 , 这个映射表就相当于一个 y=f(x) 函数。应用程序通过这个映射表就可以访问到 x 页关联的 y 页了。

