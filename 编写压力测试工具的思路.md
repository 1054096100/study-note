# 编写压力测试工具的思路

1、- n 代表从测试到结束一共发起的请求数

2、- c 代表一次产生的请求个数。

3、- th 代表线程数目

ab在执行时会先“同时”建立-c条TCP连接，然后这-c条连接一直发送请求，在响应时间大于等于-t的超时时间或者所有的-n条请求数已经被发送完毕时，停止发送。



-c 代表创建多少个套接字

通过多个线程来操作这些套接字，对客户端发起请求

-n 用来控制总的请求个数



## 步骤

### 1、解析命令行

已完成

### 2、使用epoll来检查是否请求成功

### 3、每个线程都用-c个套接字对服务器发起请求

### 4、完成-c参数

完成

### 5、遇到的问题

打开的文件最多是120个左右。

线程不敢开太多。

写入套接字时候，出现：Bad file descriptor 的问题

#### **Broken pipe**

broken pipe只出现在调用write的时候。broken pipe的意思是对端的管道已经断开，往往发生在远端把这个读/写管道关闭了，你无法在对这个管道进行读写操作。从tcp的四次挥手来讲，远端已经发送了FIN序号，告诉你我这个管道已经关闭，这时候，如果你继续往管道里写数据，第一次，你会收到一个远端发送的RST信号，如果你继续往管道里write数据，操作系统就会给你发送SIGPIPE的信号，并且将errno置为Broken pipe（32），如果你的程序默认没有对SIGPIPE进行处理，那么程序会中断退出。一般情况下，可以用**signal(SIGPIPE,SIG_IGN)**忽略这个信号，这样的话程序不会退出，但是write会返回-1并且将errno置为Broken pipe（32）。broken pipe只会出现在往对端已经关闭的管道里写数据的情况下（在收到对端的RST序号后第一次写不会出现broke pipe，而是write返回-1，这时候正确的做法应该是本端也close这个管道，如果继续write，那么就会出现这个错误）。

**原因是nginx没有开启HTTP1.1导致每次客户端请求完都会断开连接，所以此时无法继续往原来的套接字里面写入东西。**因此需要开启HTTP1.1。

HTTP1.1的话，还需要加上一行写明host, **这是http1.1的要求**。

#### 没有清空套接字上一次接受缓冲区的数据

导致一次响应的数据，判定为多次请求成功。

同一段代码，线程执行两次。