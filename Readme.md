# Readme

## 架构设计

### 1、解析命令行选项

关键代码：

```C
getopt(argc, argv, "n:c:p:u:")
```

解析出的选项有：

```
-n 总请求数
-c 连接数
-p 线程数
-u 目标主机
（其中，服务器默认端口是80）
```

### 2、构造请求行和请求头

使用的是GET方法，访问**网站的**根目录，使用HTTP1.1来保持长连接。

这里当时遇到了一个问题：
如果要使用HTTP1.1保持长连接，那么不仅仅要构造请求行，还需要构造请求头中的host字段。当时折腾了一段时间。

遇到的另一个问题是在第二次往服务器发送请求的时候，出现了Broken pipe问题。结果排查发现，是我在往套接字里面写入内容的时候，TCP连接已经断开了。所以写入失败。断开的原因是没有使用HTTP1.1导致每次客户端请求完都会断开连接，所以此时无法继续往原来的套接字里面写入东西。

### 3、创建线程

根据命令行的选项 -p 来创建对应数目的进程，然后线程开始向服务器发起请求。

每个线程在执行的任务中，多创建了-c个套接字。来模拟-c个客户端向服务器发起连接。

### 4、注册信号处理函数

用来定时，默认为1s。当时间到了，修改timerexpired全局变量，从而结束线程对服务器发出请求。

### 5、打印结果

## 使用方式

```shell
gcc presstest.c
```

```Shell
./a.out -n 1 -c 1 -p 1 -u localhost
```

## 存在的一些问题

这个软件有个bug：有时主线程还没打印出结果就已经退出了。所以可能需要多执行几次命令：

```shell
./a.out -n 1 -c 1 -p 1 -u localhost
```

## 某次测试结果

```shell
root@/codeDir/CCode/presstest# ./a.out -n 1 -c 10 -p 4 -u localhost
连接数10
线程数目4
正在进行测试...
失败次数：0
成功次数：5998
每分钟成功：359880
```

这是多次使用`./a.out -n 1 -c 10 -p 4 -u localhost`得到的结果，有几次执行命令会失败。

